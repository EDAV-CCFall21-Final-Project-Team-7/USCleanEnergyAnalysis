# Results
## Renewable Fuel Adoption
The below chart explores the average percent of power generated in 2021 by each state that is produced by renewable energy sources. Renewable energy sources include wind, solar, geothermal, biomass, and hydroelectric power sources.

```{r, warning=F, echo=F}
library(tidyverse)
df <- read.csv('data/clean/clean_monthly_fuel_generation.csv')
# df$fuel <- trimws(df$fuel) 
df$date <- as.Date(df$date)
# df[is.na(df$thousand_megawatthours),]$thousand_megawatthours <- 0
# df$fuel <- gsub(" ", "_", df$fuel)
# df$fuel <- gsub("-", "_", df$fuel)
#Update solar summation to be correct
# df <- df %>% pivot_wider(id_cols = c(date, state), names_from=c(fuel), values_from = thousand_megawatthours)
# df <- df %>% rowwise() %>% mutate(all_solar = sum(small_scale_solar_photovoltaic, all_utility_scale_solar, na.rm = TRUE))
# df <- df %>% pivot_longer(cols=names(df)[3:21],  names_to='fuel', values_to='thousand_megawatthours')
```

```{r, warning=F, echo=F}
current <- df %>% filter(date >= as.Date('2021-01-01'))
current_states <- current %>% group_by(state, fuel) %>% summarize(total_thousand_mwh = mean(thousand_megawatthours, na.rm=TRUE)) %>% pivot_wider(id_cols = c(state), names_from= fuel, values_from = total_thousand_mwh)
current_states[is.na(current_states)] <- 0
current_states <- current_states[names(current_states) %in% c('state', 'coal', 'petroleum_liquids','petroleum_coke','natural_gas', 'other_gases', 'nuclear', 'conventional_hydroelectric', 'other', 'other_renewables_(total)')]
current_states_percent <- current_states %>% 
  gather(variable, value, -state) %>% 
  group_by(state) %>% 
  mutate(percentage = value/sum(value, na.rm=TRUE)*100) %>% 
  select(-value) %>% 
  spread(variable, percentage)
current_states_percent$renewables <- current_states_percent$conventional_hydroelectric + current_states_percent$`other_renewables_(total)`
plot_df <- current_states_percent[names(current_states_percent) %in% c('state', 'coal', 'renewables')]
plot_df <- plot_df %>% pivot_longer(cols = !state, names_to = "fuel", values_to = "percent")

ggplot(current_states_percent, aes(x = renewables, y = fct_reorder(state, renewables))) +
  geom_point(color = "blue") +
  ggtitle("2021 Average Renewable Percent of Total Power Generation") +
  xlab("Average Renewables Percent of Net Generation") +
  ylab("State") + 
  theme_linedraw() +
  theme(plot.title = element_text(hjust=.5))
options(repr.P.width=4,repr.P.height=10)
```

It is interesting to note that Vermont is already generating 100% of their power from renewable energy sources. Additionally, Mississippi has the lower percentage of power generated from renewables with these sources comprising just over 2% of the average 2021 power.

Some states have set Renewable Portfolio Goals (RPS) that specify that utilities must sell a certain percentage of electricity that is generated from renewable sources. Delaware set a goal in 2005 to achieve achieve power generation that is 25% renewables by 2025 (https://www.ncsl.org/research/energy/renewable-portfolio-standards.aspx); however, they have only achieved 3% renewables in the current year. 

## Macro Trends
To explore macro trends in the energy sources utilized by the United States as a whole, the time series for each power source is plotted from 2001 - 2021. It is seen below that in 2001 coal was the predominant electricity source for America. Coal had a steady power generation until it began to decline around 2010. Natural gas took off at this time and by 2021 is the biggest producer of energy. Conventional hydroelectric was one of the first renewable energy resources to appear at significant levels in the electricity power generation for the US. Both solar and wind power have slowly increased in the amount of power they produce. 

```{r, echo=F, warning=F}
df  %>% 
  group_by(fuel, date) %>% summarise(thousand_megawatthours = sum(thousand_megawatthours, na.rm = TRUE)) %>% filter(fuel %in% c('all_solar', 'coal','natural_gas', 'wind', 'nuclear', 'conventional_hydroelectric')) %>%
  ggplot(aes(x = date, y = thousand_megawatthours, color = fct_relevel(fuel, c('natural_gas', 'coal','nuclear', 'conventional_hydroelectric', 'wind', 'solar')))) +
  geom_line() +
  theme_classic() +
  ggtitle('USA Net Generation by Fuel Type') + 
  xlab("Date") +
  ylab("MW Hours (thousand)") +
  theme(legend.title=element_blank(), plot.title = element_text(hjust=.5))
```

We can explore the relationship between specific fuel types to determine which are correlated. From the plot below, it appears that coal is negatively correlated with both solar and natural gas. This is not necessarily surprising because natural gas is typically used to complement renewable energy sources and act as a form of stability to produce power when the sun isn't shining or the wind isn't blowing. 

```{r, echo=F, warning=F}
library(GGally)
df  %>% filter(fuel %in% c('wind','coal', 'natural_gas', 'all_solar')) %>%
  select(c(fuel, date, thousand_megawatthours)) %>% 
  group_by(fuel, date) %>% 
  summarise(thousand_megawatthours = sum(thousand_megawatthours, na.rm = TRUE)) %>% ungroup()  %>%
  pivot_wider(names_from=fuel, id_cols = date, values_from = thousand_megawatthours) %>%
  ggparcoord(columns=c(array(2:5)), scale= "uniminmax", alphaLines = .3, splineFactor = 9) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        plot.title = element_text(hjust=.5)) +
  ggtitle('Relationship between Fuel Types') +
  xlab("Fuel") +
  ylab("") 
```


```{r,fig.width=16,fig.height=16}
df_all_solar <- df  %>% 
  group_by(fuel, date, state) %>% summarise(thousand_megawatthours = sum(thousand_megawatthours)) %>% filter(fuel %in% c('all_solar'))

df_coal <- df  %>% 
  group_by(fuel, date, state) %>% summarise(thousand_megawatthours = sum(thousand_megawatthours)) %>% filter(fuel %in% c('coal'))

df_natural_gas <- df  %>% 
  group_by(fuel, date, state) %>% summarise(thousand_megawatthours = sum(thousand_megawatthours)) %>% filter(fuel %in% c('natural_gas'))

df_wind <- df  %>% 
  group_by(fuel, date, state) %>% summarise(thousand_megawatthours = sum(thousand_megawatthours)) %>% filter(fuel %in% c('wind'))

df_all_solar1 <- df_all_solar %>% group_by(state) %>% summarize(thousand_megawatthours = mean(thousand_megawatthours)) 

df_coal1 <- df_coal %>% group_by(state) %>% summarize(thousand_megawatthours = mean(thousand_megawatthours)) 

df_natural_gas1 <- df_natural_gas %>% group_by(state) %>% summarize(thousand_megawatthours = mean(thousand_megawatthours)) 

df_wind1 <- df_wind %>% group_by(state) %>% summarize(thousand_megawatthours = mean(thousand_megawatthours)) 


library(usmap)

g1 <- plot_usmap(data = df_all_solar1, values = 'thousand_megawatthours',regions = 'states', labels = TRUE, color = 'pink')+
  scale_fill_continuous(low = "pink", high = "red", name = "Average thousand megawatthours", label = scales::comma) + 
  labs(title = "Average thousand megawatthours by State (Solar Energy)") +
  theme(legend.position = "right",plot.title = element_text(hjust = 0.5,size=10))

g2 <- plot_usmap(data = df_coal1, values = 'thousand_megawatthours',regions = 'states', labels = TRUE, color = 'pink')+
  scale_fill_continuous(low = "pink", high = "red", name = "Average thousand megawatthours", label = scales::comma) + 
  labs(title = "Average thousand megawatthours by State (Coal)") +
  theme(legend.position = "right",plot.title = element_text(hjust = 0.5,size=10))

g3 <- plot_usmap(data = df_natural_gas1, values = 'thousand_megawatthours',regions = 'states', labels = TRUE, color = 'pink')+
  scale_fill_continuous(low = "pink", high = "red", name = "Average thousand megawatthours", label = scales::comma) + 
  labs(title = "Average thousand megawatthours by State (Natual Gas)") +
  theme(legend.position = "right",plot.title = element_text(hjust = 0.5,size=10))

g4 <- plot_usmap(data = df_wind1, values = 'thousand_megawatthours',regions = 'states', labels = TRUE, color = 'pink')+
  scale_fill_continuous(low = "pink", high = "red", name = "Average thousand megawatthours", label = scales::comma) + 
  labs(title = "Average thousand megawatthours by State (Wind Energy)") +
  theme(legend.position = "right",plot.title = element_text(hjust = 0.5,size=10))

library(patchwork)

g1+g2+g3+g4+plot_layout(ncol=2,nrow=2,widths=c(8,8),heights=c(38,38))
```

## Correlation of Energy Consumption, CO2 Emission and Economic Indicators

```{r, echo=F, warning=F}

library(tidyverse)
library (dplyr)
library(GGally)

us_wb_df <- as.data.frame(read_csv('data/raw/clean_worldbank.csv'))
row.names(us_wb_df)<-us_wb_df[,"Series"]
us_wb_df <-us_wb_df[,2:length(names(us_wb_df))]

rownames(us_wb_df) <- c('Pop T', 'Pop G', 'Area', 'Pov Rt', 'GNI T','GNI Pc', 'GNI PPP', 'GNI PPP Pc', 'Inc Shr', 'Life Exp', 'Fertility Rt', 'Ado Ft', 'Contr Pr', 'Birth Rt', 'Mort Rt', 'Under Wt', 'Imm Mea', 'Prim Comp', 'Sec Sch', 'Prim Sch', 'HIV', 'Forest A', 'Water P', 'Energy Use', 'C02 Em', 'Elec Pwr', 'GDP T', 'GDP %', 'Infl %', 'Agri %', 'Industry %', 'Exports %', 'Imports %', 'Gross %', 'Revenue, %', 'Start up', 'Mkt Cap %', 'Military %', 'Mobile Sub', 'HT Exp %', 'Merchandise %', 'Net Bart', 'Ext Debt', 'Debt Sv %', 'Migration', 'Remittance', 'FDI', 'ODA')

my_us_wb_df_p <- as.data.frame(t(us_wb_df))

my_us_wb_df_p <- my_us_wb_df_p %>% relocate('GDP %', .before = 'GDP T')
my_us_wb_df_p <- my_us_wb_df_p %>% relocate('GNI Pc', .before = 'GDP %')

ggparcoord(my_us_wb_df_p, columns = 23:27, scale = "globalminmax") + 
  geom_vline(xintercept = 1:8, color = "lightblue") +
  ggtitle("US Macro Energy Consumption, CO2 Emission, & Economic Indicators ") + 
  xlab("") + 
  ylab("") +
  theme(plot.title = element_text(hjust=.5))


ggparcoord(my_us_wb_df_p, columns = 23:27, scale = "uniminmax", alphaLines = 0.3, splineFactor = 10) + 
  geom_vline(xintercept = 1:8, color = "lightblue") +
  ggtitle("US Macro Energy Consumption, CO2 Emission, & Economic Indicators ") + 
  xlab("") + 
  ylab("") +
  theme(plot.title = element_text(hjust=.5))


```


## Correlation between Energy ETF and macro trends in energy
```{r}
min_max_norm <- function(x) {
    (x - min(x)) / (max(x) - min(x))
  }

oil <- read_csv('data/clean/clean_crushing_crude_oil.csv')
oil$Day <- as.Date(oil$Day,format = '%m/%d/%Y')
names(oil) <- c("Date","Cost")


#cnrg <-read_csv('data/raw/CNRG.csv')
#icln <- read_csv('data/raw/ICLN.csv')
xle <- read_csv('data/raw/XLE.csv')



#cnrg$Close<-as.data.frame(lapply(cnrg[5],min_max_norm))$Close
#icln$Close<-as.data.frame(lapply(icln[5],min_max_norm))$Close
xle$Close<-as.data.frame(lapply(xle[5],min_max_norm))$Close


energy_df <- df  %>% 
  group_by(fuel, date) %>%
  summarise(thousand_megawatthours = sum(thousand_megawatthours, na.rm = TRUE)) %>%
  filter(fuel %in% c('all_solar', 'coal','natural_gas', 'wind', 'nuclear', 'conventional_hydroelectric'))

total_energy <- energy_df %>% 
  group_by(date) %>% 
  summarise(thousand_megawatthours = sum(thousand_megawatthours, na.rm = TRUE))

total_energy$thousand_megawatthours<-as.data.frame(lapply(total_energy[2],min_max_norm))$thousand_megawatthours

names(total_energy) <- c('Date','thousand_megawatthours')

colors<-c("Total enegry (normalized)" = "red", "Normalized Closing Price (XLE)" = "blue")
merged_data <-merge(xle,total_energy,by='Date')

g1<-ggplot(merged_data)+
  geom_line(aes(Date,thousand_megawatthours,color="Total enegry (normalized)"))+
  geom_line(aes(Date,Close,color="Normalized Closing Price (XLE)"))+
  labs(x='Year', y='normalized scale',color='Legend')


df_solar2 <- df_all_solar %>% 
  group_by(date) %>% 
  summarize(solar_megawatt = sum(thousand_megawatthours)) 

df_solar2$solar_megawatt<-as.data.frame(lapply(df_solar2[2],min_max_norm))$solar_megawatt

df_coal2 <- df_coal %>% 
  group_by(date) %>% 
  summarize(coal_megawatt = sum(thousand_megawatthours)) 

df_coal2$coal_megawatt<-as.data.frame(lapply(df_coal2[2],min_max_norm))$coal_megawatt

df_natural_gas2 <- df_natural_gas %>% 
  group_by(date) %>% 
  summarize(gas_megawatt = sum(thousand_megawatthours)) 

df_natural_gas2$gas_megawatt<-as.data.frame(lapply(df_natural_gas2[2],min_max_norm))$gas_megawatt

df_wind2 <- df_wind %>% 
  group_by(date) %>% 
  summarize(wind_megawatt = sum(thousand_megawatthours)) 

df_wind2$wind_megawatt<-as.data.frame(lapply(df_wind2[2],min_max_norm))$wind_megawatt

names(xle)<-c("date","Open","High","Low","Close","Adj Close","Volume")

colors<-c("solar"="goldenrod3","coal"="grey1","natural gas"="darkolivegreen3","wind"="dodgerblue3","close price (XLE)"="red")

merged_data1 <-merge(xle,df_solar2,by='date')
merged_data2 <-merge(merged_data1,df_coal2,by='date')
merged_data3 <-merge(merged_data2,df_natural_gas2,by='date')
merged_data <-merge(merged_data3,df_wind2,by='date')

g2<-ggplot(merged_data)+
  geom_line(aes(date,solar_megawatt,color="solar"))+
  geom_line(aes(date,coal_megawatt,color="coal"))+
  geom_line(aes(date,gas_megawatt,color="natural gas"))+
  geom_line(aes(date,wind_megawatt,color="wind"))+
  geom_line(aes(date,Close,color="close price (XLE)"))+
  labs(x='Year', y='normalized scale',color='Legend')+
  scale_color_manual(values=colors)


g1+g2+plot_layout(nrow=2,ncol=1)

```


